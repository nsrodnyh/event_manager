{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">üé´ –ö–æ–Ω—Ç—Ä–æ–ª—å –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏: {{ event.title }}</h2>
<p><strong>–î–∞—Ç–∞:</strong> {{ event.date|date:"j E Y –≤ H:i" }}</p>
{% csrf_token %}
<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
    {% for reg in registrations %}
    <div class="col">
        <div class="card shadow-sm h-100">
            <div class="card-body">
                <h5 class="card-title">{{ reg.full_name }}</h5>
                <p class="card-text text-muted mb-1">{{ reg.phone }}</p>
                <p class="card-text text-muted small">{{ reg.email }}</p>

                <div class="form-check form-switch mt-3">
                    <input  type="checkbox"
                            class="form-check-input"
                            id="reg-{{ reg.id }}"
                            {% if reg.checked_in %}checked{% endif %}
                            onclick="toggleCheckin(this,
                                '{% url 'toggle_checkin' event.id reg.id %}')">

                    <label class="form-check-label" for="reg-{{ reg.id }}">
                        {% if reg.checked_in %}
                            ‚úÖ –û—Ç–º–µ—Ç–∫–∞: –ü—Ä–∏—à—ë–ª
                        {% else %}
                            ‚ùå –ù–µ –ø—Ä–∏—à—ë–ª
                        {% endif %}
                    </label>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
        <p class="text-muted">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
    {% endfor %}
</div>

<div class="mt-4">
    <form method="post" action="{% url 'logout' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn btn-link p-0 m-0 align-baseline">
            üö™ –í—ã–π—Ç–∏
        </button>
    </form>
</div>

<!-- ========== JS ========== -->
<script>
  /* --- –ø–æ–ª—É—á–∞–µ–º CSRF-—Ç–æ–∫–µ–Ω –∏–∑ cookie --- */
  function getCookie(name) {
      const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
      return v ? v.split('=')[1] : null;
  }
  const csrftoken = getCookie('csrftoken');

  /* --- AJAX-–æ—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–µ–Ω–∏—è --- */
  function toggleCheckin(checkbox, url) {
      fetch(url, {
          method: 'POST',
          credentials: 'same-origin',                 // ‚Üê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º cookie!
          headers: {
              'X-CSRFToken': csrftoken,
              'X-Requested-With': 'XMLHttpRequest'
          }
      })
      .then(r => {
          if (!r.ok) throw new Error('fail');
          return r.json();
      })
      .then(data => {
          const label = checkbox.nextElementSibling;
          if (data.checked) {
              label.textContent = '‚úÖ –û—Ç–º–µ—Ç–∫–∞: –ü—Ä–∏—à—ë–ª';
          } else {
              label.textContent = '‚ùå –ù–µ –ø—Ä–∏—à—ë–ª';
          }
      })
      .catch(() => {
          checkbox.checked = !checkbox.checked;       // –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
      });
  }
</script>

{% endblock %}

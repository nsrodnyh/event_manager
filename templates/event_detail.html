{% extends 'base.html' %}
{% load tz %}
{% block content %}

    <h2 class="mb-4">{{ event.title }}</h2>

    <div class="mb-3">
        <p><strong>–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> {{ event.date|date:"j E Y –≤ H:i" }}</p>
        <p><strong>–û–∫–æ–Ω—á–∞–Ω–∏–µ:</strong> {{ event.end_date|date:"j E Y –≤ H:i" }}</p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ event.description|default:"(–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è)" }}</p>
        <p><strong>–ú–µ—Å—Ç–æ:</strong> {{ event.location|default:"(–Ω–µ —É–∫–∞–∑–∞–Ω–æ)" }}</p>
    </div>

    {% if event.cover %}
        <img src="{{ event.cover.url }}" class="img-fluid my-3" alt="–û–±–ª–æ–∂–∫–∞">
    {% endif %}

    <p><strong>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–æ:</strong> {{ event.registration_deadline|date:"j E Y H:i" }}</p>

    {% if user.profile.role == 'organizer' and user == event.created_by %}
        <div class="mb-4">
            <a href="{% url 'add_schedule_item' event.id %}" class="btn btn-outline-primary btn-sm">‚ûï –î–æ–±–∞–≤–∏—Ç—å
                –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</a>
            <a href="{% url 'add_material' event.id %}" class="btn btn-outline-secondary btn-sm">üìé –î–æ–±–∞–≤–∏—Ç—å
                –º–∞—Ç–µ—Ä–∏–∞–ª—ã</a>
            <a href="{% url 'view_participants' event.id %}" class="btn btn-outline-info btn-sm">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</a>
            <a href="{% url 'event_stats' event.id %}" class="btn btn-outline-dark btn-sm">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
            <a href="{% url 'edit_event' event.id %}" class="btn btn-outline-warning btn-sm">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="{% url 'delete_event' event.id %}" class="btn btn-outline-danger  btn-sm">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
        </div>

        <div class="mt-4">
            <h5>üîó –ü—É–±–ª–∏—á–Ω–∞—è —Å—Å—ã–ª–∫–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h5>
            <div class="input-group">
                <input id="publicLink" type="text" class="form-control" value="{{ public_link }}" readonly>
                <button class="btn btn-outline-secondary" type="button"
                        onclick="navigator.clipboard.writeText(document.getElementById('publicLink').value)">
                    üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                </button>
            </div>
            <small class="text-muted">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º ‚Äî –ø–æ –Ω–µ–π –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –Ω–∞ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.</small>
        </div>

        <script>
            const copyBtn = document.querySelector('button[onclick^="navigator.clipboard"]');
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    copyBtn.innerText = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ';
                    setTimeout(() => copyBtn.innerText = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å', 2000);
                });
            }
        </script>
    {% endif %}

    <hr>

    <h4>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h4>
    {% if event.schedule_items.exists %}
        <table class="table table-striped table-bordered">
            <thead>
            <tr>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–í—Ä–µ–º—è</th>
                <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                <th>–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</th>
                {% if user == event.created_by and user.profile.role == 'organizer' %}
                    <th class="text-center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for item in event.schedule_items.all %}
                <tr>
                    <td>{{ item.title }}</td>
                    <td>{{ item.start_time|time:"H:i" }}‚Äì{{ item.end_time|time:"H:i" }}</td>
                    <td>{{ item.description|default:"‚Äî" }}</td>
                    <td>
                        {% for m in item.materials.all %}
                            <a href="{{ m.file.url }}" class="d-block">{{ m.description }}</a>
                        {% empty %}
                            <span class="text-muted">–ù–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤</span>
                        {% endfor %}
                        {% if user == event.created_by and user.profile.role == 'organizer' %}
                            <a href="{% url 'add_material_to_activity' event.id item.id %}" class="btn btn-link btn-sm">+
                                –ú–∞—Ç–µ—Ä–∏–∞–ª</a>
                        {% endif %}
                    </td>

                    {% if user == event.created_by and user.profile.role == 'organizer' %}
                        <td class="text-center">
                            <a href="{% url 'edit_schedule_item' item.id %}" class="btn btn-outline-secondary btn-sm"
                               title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</a>
                            <a href="{% url 'delete_schedule_item' item.id %}" class="btn btn-outline-danger btn-sm"
                               title="–£–¥–∞–ª–∏—Ç—å"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ¬´{{ item.title }}¬ª?');">üóëÔ∏è</a>
                        </td>
                    {% endif %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ.</p>
    {% endif %}

    <hr>

    <h4>üìÇ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—é</h4>
    {% if event.materials.exists %}
        <ul>
            {% for material in event.materials.all %}
                <li><a href="{{ material.file.url }}">{{ material.description }}</a></li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="text-muted">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.</p>
    {% endif %}

    {% if not is_registered and user.profile.role != 'organizer' %}
        <a href="{% url 'register_for_event' event.id %}" class="btn btn-success">üìå –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
    {% elif is_registered %}
        <p class="text-success">‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã</p>
    {% endif %}

    {% timezone "Europe/Moscow" %}
        {% now "Y-m-d H:i:s" as now_msk %}
    {% endtimezone %}

    <h4>üí¨ –û—Ç–∑—ã–≤—ã –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</h4>

    {% if feedback_event %}
        <p>
            <strong>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:</strong>
            {% with avg=avg_event_rating|default:0 %}
                {% with rounded=avg|floatformat:0 %}
                    {% for _ in "12345"|make_list %}
                        {% if forloop.counter <= rounded|add:"0" %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                    ({{ avg|floatformat:1 }})
                {% endwith %}
            {% endwith %}
        </p>

        <div class="list-group mb-4">
            {% for fb in feedback_event %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <strong>{{ fb.registration.full_name }}</strong>
                        <span class="text-warning">
                  {% for _ in "12345"|make_list %}
                      {% if forloop.counter <= fb.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                  {% endfor %}
              </span>
                    </div>

                    {#  ‚Üì  –≤–æ—Ç —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞ ‚Üì  #}
                    <p class="mb-1 mt-2">{{ fb.text|default:"‚Äî"|linebreaksbr }}</p>

                    <small class="text-muted">{{ fb.created_at|localtime|date:"d.m.Y H:i" }}</small>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
    {% endif %}

    {% if feedback_by_activity %}
        <h4>üìë –û—Ç–∑—ã–≤—ã –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º</h4>

        {% for fb_data in feedback_by_activity.values %}
            <h5 class="mt-3">{{ fb_data.activity.title }}</h5>

            {% if fb_data.feedbacks %}
                <p>
                    –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥:
                    {% with avg=fb_data.avg_rating|default:0 %}
                        {% with rounded=avg|floatformat:0 %}
                            {% for _ in "12345"|make_list %}
                                {% if forloop.counter <= rounded|add:"0" %}‚òÖ{% else %}‚òÜ{% endif %}
                            {% endfor %}
                            ({{ avg|floatformat:1 }})
                        {% endwith %}
                    {% endwith %}
                </p>

                <ul class="list-unstyled">
                    {% for fb in fb_data.feedbacks %}
                        <li class="mb-2">
                            <strong>{{ fb.registration.full_name }}</strong> ‚Äî
                            {% for _ in "12345"|make_list %}
                                {% if forloop.counter <= fb.rating %}‚òÖ{% else %}‚òÜ{% endif %}
                            {% endfor %}
                            <br>
                            {{ fb.text|default:"‚Äî"|linebreaksbr }} {# ‚Üê –≤—ã–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ #}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% if is_registered and user.profile.role != 'organizer' %}
        {% if event.end_date|localtime <= now_msk|date:"Y-m-d H:i:s" %}
            <a href="{% url 'leave_feedback' event.id %}" class="btn btn-outline-success mt-3">üìù –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</a>
        {% else %}
            <p class="text-muted mt-3 fst-italic">
                –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ {{ event.end_date|date:"j E Y –≤ H:i" }}
            </p>
        {% endif %}
    {% endif %}

{% endblock %}

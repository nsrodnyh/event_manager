{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}

    <!-- ‚ïê‚ïó –ó–∞–≥–æ–ª–æ–≤–æ–∫ ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <h2 class="text-2xl md:text-3xl font-semibold flex items-center gap-2 mb-8">
        üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏&nbsp;–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:
        <span class="text-indigo-600 dark:text-indigo-400">{{ event.title }}</span>
    </h2>

    <!-- ‚ïê‚ïó –§–∏–ª—å—Ç—Ä—ã ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <form method="get"
          class="flex flex-col gap-4 md:flex-row md:flex-wrap md:items-end mb-10">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="md:w-60">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                –ü–æ–∏—Å–∫&nbsp;–ø–æ&nbsp;–∏–º–µ–Ω–∏
            </label>
            <input type="text" name="search" value="{{ search }}"
                   class="w-full rounded-lg border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-700/40
                      text-gray-900 dark:text-gray-100 text-sm px-3 py-2
                      focus:border-indigo-500 focus:ring-indigo-500">
        </div>

        <!-- –ü–æ—Å–µ—Ç–∏–ª / –Ω–µ –ø—Ä–∏—à—ë–ª -->
        <div class="md:w-48">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                –°—Ç–∞—Ç—É—Å&nbsp;–ø–æ—Å–µ—â–µ–Ω–∏—è
            </label>
            <select name="checked_in"
                    class="w-full rounded-lg border-gray-300 dark:border-gray-600
                       bg-gray-50 dark:bg-gray-700/40
                       text-gray-900 dark:text-gray-100 text-sm px-3 py-2">
                <option value="">–í—Å–µ</option>
                <option value="yes" {% if checkin_filter == 'yes' %}selected{% endif %}>–¢–æ–ª—å–∫–æ&nbsp;–ø—Ä–∏—à–ª–∏</option>
                <option value="no" {% if checkin_filter == 'no' %}selected{% endif %}>–¢–æ–ª—å–∫–æ&nbsp;–Ω–µ&nbsp;–ø—Ä–∏—à–ª–∏
                </option>
            </select>
        </div>

        <!-- –ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏—é -->
        <div class="md:flex-1">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                –ü–æ–∏—Å–∫&nbsp;–ø–æ&nbsp;–ø—Ä–∏–º–µ—á–∞–Ω–∏—é
            </label>
            <input type="text" name="note_contains" value="{{ note_query }}"
                   class="w-full rounded-lg border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-700/40
                      text-gray-900 dark:text-gray-100 text-sm px-3 py-2
                      focus:border-indigo-500 focus:ring-indigo-500">
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="flex gap-3 md:ml-auto">
            <button type="submit"
                    class="inline-flex items-center gap-2 px-5 py-2 rounded-full
                       bg-indigo-600 hover:bg-indigo-700
                       hover:-translate-y-0.5 active:translate-y-0
                       shadow hover:shadow-lg transition
                       text-white text-sm font-medium">
                üîç <span>–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</span>
            </button>

            <a href="{% url 'view_participants' event.id %}"
               class="inline-flex items-center gap-2 px-5 py-2 rounded-full
                  border border-gray-300 dark:border-gray-600
                  text-gray-700 dark:text-gray-200
                  hover:bg-gray-100 dark:hover:bg-gray-700/60
                  hover:-translate-y-0.5 active:translate-y-0
                  shadow-sm hover:shadow transition text-sm font-medium">
                ‚Ü∫ <span>–°–±—Ä–æ—Å</span>
            </a>

            <a href="{% url 'export_participants_xlsx' event.id %}?search={{ search }}&checked_in={{ checkin_filter }}&note_contains={{ note_query }}"
               class="inline-flex items-center gap-2 px-5 py-2 rounded-full
                  bg-teal-500 hover:bg-teal-600
                  hover:-translate-y-0.5 active:translate-y-0
                  shadow hover:shadow-lg transition
                  text-white text-sm font-medium">
                ‚¨áÔ∏è <span>Excel</span>
            </a>
        </div>
    </form>

    <!-- ‚ïê‚ïó –¢–∞–±–ª–∏—Ü–∞ ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="overflow-x-auto">
        <table class="min-w-[50rem] w-full text-sm border-collapse">
            <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-100">
            <tr>
                <th class="p-3 text-left">–§–ò–û</th>
                <th class="p-3">Email</th>
                <th class="p-3">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                <th class="p-3 text-center">–ü–æ—Å–µ—Ç–∏–ª</th>
                <th class="p-3">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
            </tr>
            </thead>
            <tbody>
            {% for reg in registrations %}
                <tr class="border-b border-gray-200 dark:border-gray-600">
                    <td class="p-3">{{ reg.full_name }}</td>
                    <td class="p-3 text-center">{{ reg.email }}</td>
                    <td class="p-3 text-center">{{ reg.phone }}</td>

                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–æ—Å–µ—â–µ–Ω–∏—è -->
                    <td class="p-3 text-center">
                        <button type="button"
                                class="inline-flex items-center justify-center h-8 w-8 rounded-full
                               {% if reg.checked_in %}bg-teal-500{% else %}bg-gray-600/30 dark:bg-gray-500/30{% endif %}
                               text-white hover:scale-110 transition"
                                onclick="toggleCheckin(this,'{% url 'toggle_checkin' event.id reg.id %}')">
                            {% if reg.checked_in %}‚úî{% else %}‚Äî{% endif %}
                        </button>
                    </td>

                    <!-- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ -->
                    <td class="p-3">
                        <div class="flex gap-2">
                            <input
                                    type="text"
                                    class="note-input flex-grow rounded-lg border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700/40 text-gray-900 dark:text-gray-100 text-sm px-3 py-1 focus:border-indigo-500 focus:ring-indigo-500"
                                    value="{{ reg.note }}"
                                    data-url="{% url 'update_note' event.id reg.id %}">
                            <button
                                    type="button"
                                    class="note-save-btn inline-flex items-center justify-center h-8 w-8 rounded-full
                                           bg-indigo-600 hover:bg-indigo-700 text-white text-xs transition">üíæ
                            </button>
                        </div>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="5" class="p-4 text-center text-gray-500">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        // --- CSRF –∏–∑ –∫—É–∫–∏ ---
        function getCookie(name) {
            const v = document.cookie.split('; ').find(r => r.startsWith(name + '='));
            return v ? decodeURIComponent(v.split('=')[1]) : '';
        }

        const csrftoken = getCookie('csrftoken');

        // --- –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ—á–∞–Ω–∏—è ---
        document.querySelectorAll('.note-save-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const wrapper = btn.closest('td');
                const input = wrapper.querySelector('.note-input');
                const url = input.dataset.url;

                fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: new URLSearchParams({note: input.value})
                })
                    .then(res => {
                        if (!res.ok) throw new Error();
                        return res.json();
                    })
                    .then(data => {
                        // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                        input.value = data.note;
                        // –≤–∏–∑—É–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫
                        btn.textContent = '‚úì';
                        setTimeout(() => btn.textContent = 'üíæ', 1000);
                    })
                    .catch(() => {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ.');
                    });
            });
        });
    </script>

{% endblock %}

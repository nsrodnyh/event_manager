{% extends 'base.html' %}
{% block content %}

<h2 class="mb-4">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: {{ event.title }}</h2>

<!-- üîé –§–∏–ª—å—Ç—Ä—ã -->
<form method="get" class="row g-2 mb-3">
    <div class="col-md-3">
        <input type="text" name="search" value="{{ search }}" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏">
    </div>
    <div class="col-md-3">
        <select name="checked_in" class="form-select">
            <option value="">–í—Å–µ</option>
            <option value="yes" {% if checkin_filter == 'yes' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –ø—Ä–∏—à–ª–∏</option>
            <option value="no" {% if checkin_filter == 'no' %}selected{% endif %}>–¢–æ–ª—å–∫–æ –Ω–µ –ø—Ä–∏—à–ª–∏</option>
        </select>
    </div>
    <div class="col-md-3">
        <input type="text" name="note_contains" value="{{ note_query }}" class="form-control" placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏—é">
    </div>
    <div class="col-md-3 d-flex gap-2">
        <button type="submit" class="btn btn-primary">üîç –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        <a href="{% url 'view_participants' event.id %}" class="btn btn-outline-secondary">‚Ü∫ –°–±—Ä–æ—Å</a>
        <a href="{% url 'export_participants_xlsx' event.id %}?search={{ search }}&checked_in={{ checkin_filter }}&note_contains={{ note_query }}" class="btn btn-success">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</a>
    </div>
</form>

<!-- üìã –¢–∞–±–ª–∏—Ü–∞ -->
<table class="table table-bordered table-striped align-middle">
    <thead class="table-dark">
        <tr>
            <th>–§–ò–û</th>
            <th>Email</th>
            <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th>–ü–æ—Å–µ—Ç–∏–ª</th>
            <th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
        </tr>
    </thead>
    <tbody>
        {% for reg in registrations %}
        <tr>
            <td>{{ reg.full_name }}</td>
            <td>{{ reg.email }}</td>
            <td>{{ reg.phone }}</td>
            <td class="text-center">
                <button type="button"
                        class="btn btn-sm {% if reg.checked_in %}btn-success{% else %}btn-outline-secondary{% endif %}"
                        onclick="toggleCheckin(this, '{% url 'toggle_checkin' event.id reg.id %}')">
                    {% if reg.checked_in %}‚úî{% else %}‚Äî{% endif %}
                </button>
            </td>
            <td>
                <form method="post" action="{% url 'update_note' event.id reg.id %}" class="d-flex">
                    {% csrf_token %}

                    <input type="text" name="note" value="{{ reg.note }}" class="form-control me-2" placeholder="–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ">

                    <button type="submit" class="btn btn-outline-primary btn-sm">üíæ</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</td></tr>
        {% endfor %}
    </tbody>
</table>
<script>
  /* ---- CSRF ---- */
  function getCookie(name) {
      const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return m ? m[2] : '';
  }
  const csrftoken = getCookie('csrftoken');

  /* ---- AJAX-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å ---- */
  function toggleCheckin(btn, url) {
      fetch(url, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'X-CSRFToken': csrftoken}
      })
      .then(r => r.ok ? r.json() : Promise.reject(r))
      .then(data => {
          btn.classList.toggle('btn-success',  data.checked);
          btn.classList.toggle('btn-outline-secondary', !data.checked);
          btn.textContent = data.checked ? '‚úî' : '‚Äî';
      })
      .catch(() => {
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É.');
      });
  }
</script>
{% endblock %}

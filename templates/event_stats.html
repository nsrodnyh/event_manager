{% extends "base.html" %}
{% block content %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2 class="text-2xl md:text-3xl font-semibold flex items-center gap-2 mb-6">
    üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:
    <span class="text-indigo-600 dark:text-indigo-400">{{ event.title }}</span>
</h2>

<p class="mb-8">
    <span class="font-medium">–î–∞—Ç–∞:</span>
    {{ event.date|date:"j E Y ¬∑ H:i" }}
</p>

<div class="flex flex-wrap gap-3 mb-10">
    <a href="{% url 'event_stats_pdf' event.id %}"
       class="inline-flex items-center gap-2 px-5 py-2 rounded-full
              border border-gray-300 dark:border-gray-600
              text-gray-700 dark:text-gray-200
              hover:bg-gray-100 dark:hover:bg-gray-700/60
              hover:-translate-y-0.5 active:translate-y-0
              shadow-sm hover:shadow transition text-sm font-medium">
        üì• <span>–°–∫–∞—á–∞—Ç—å&nbsp;PDF</span>
    </a>

    <a href="{% url 'event_detail' event.id %}"
       class="inline-flex items-center gap-2 px-5 py-2 rounded-full
              bg-gray-800/90 text-gray-100 hover:bg-gray-900
              hover:-translate-y-0.5 active:translate-y-0
              shadow hover:shadow-lg transition text-sm font-medium">
        ‚Üê <span>–ù–∞–∑–∞–¥</span>
    </a>
</div>

<!-- ‚ïê‚ïó –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<h3 class="text-xl font-semibold mb-4">üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h3>
<ul class="list-disc list-inside mb-6">
    <li>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: <strong>{{ total }}</strong></li>
    <li>‚úÖ –ü—Ä–∏—à–ª–∏: <strong>{{ attended }}</strong></li>
    <li>‚ùå –ù–µ –ø—Ä–∏—à–ª–∏: <strong>{{ missed }}</strong></li>
</ul>

<div class="w-full sm:max-w-md md:max-w-lg lg:max-w-xl mx-auto mb-16">
    <div class="relative" style="aspect-ratio: 1 / 1;">
        <canvas id="attendanceChart"></canvas>
    </div>
</div>

<!-- ‚ïê‚ïó –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<h3 class="text-xl font-semibold mb-4">‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
<p class="text-3xl font-semibold mb-16">
    {{ avg_rating|default:"‚Äî" }}/5
</p>

<!-- ‚ïê‚ïó –†–µ–π—Ç–∏–Ω–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<h3 class="text-xl font-semibold mb-4">üìà –†–µ–π—Ç–∏–Ω–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h3>

<div class="w-full sm:max-w-lg lg:max-w-3xl mx-auto mb-10">
    <div class="relative" style="aspect-ratio: 2 / 1;">
        <canvas id="ratingsChart"></canvas>
    </div>
</div>

<table class="w-full text-sm border-collapse mb-20">
    <thead class="bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-100">
        <tr>
            <th class="p-3 text-left">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th class="p-3">–°—Ä–µ–¥–Ω–∏–π&nbsp;—Ä–µ–π—Ç–∏–Ω–≥</th>
            <th class="p-3">–û—Ç–∑—ã–≤—ã</th>
        </tr>
    </thead>
    <tbody>
        {% for a in activity_data %}
            <tr class="border-b border-gray-200 dark:border-gray-600">
                <td class="p-3">{{ a.title }}</td>
                <td class="p-3 text-center">{{ a.avg_rating|floatformat:1 }}</td>
                <td class="p-3 text-center">{{ a.feedback_count }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="3" class="p-4 text-center text-gray-500">
                    –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π
                </td>
            </tr>
        {% endfor %}
    </tbody>
</table>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const attendanceCtx = document.getElementById('attendanceChart');
new Chart(attendanceCtx, {
    type: 'pie',
    data: {
        labels: ['–ü—Ä–∏—à–ª–∏', '–ù–µ –ø—Ä–∏—à–ª–∏'],
        datasets: [{
            data: [{{ attended }}, {{ missed }}],
            backgroundColor: ['#14b8a6', '#ef4444']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins:{ title:{ display:true, text:'–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å' } }
    }
});

const ratingsCtx = document.getElementById('ratingsChart');
new Chart(ratingsCtx, {
    type: 'bar',
    data: {
        labels: [{% for a in activity_data %}'{{ a.title|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        datasets:[{
            label:'–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥',
            data:[{% for a in activity_data %}{{ a.avg_rating|default:"0" }}{% if not forloop.last %}, {% endif %}{% endfor %}],
            backgroundColor:'#6366f1'
        }]
    },
    options:{
        responsive:true,
        maintainAspectRatio:false,

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û—Å–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        scales:{
            x:{
                ticks:{ color:'#d1d5db' },                       // –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏-X
                grid :{ color:'rgba(255,255,255,.05)' }
            },
            y:{
                beginAtZero:true, max:5,
                ticks:{ color:'#d1d5db' },                       // –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏-Y
                grid :{ color:'rgba(255,255,255,.05)' }
            }
        },

        /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¢–∏—Ç—É–ª –∏ –ª–µ–≥–µ–Ω–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
        plugins:{
            title:{
                display:true,
                text:'–†–µ–π—Ç–∏–Ω–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π',
                color:'#d1d5db',
                padding:{bottom:12},
                font:{ size:16, weight:'600' }
            },
            legend:{
                labels:{ color:'#d1d5db' }
            }
        }
    }
});
</script>

{% endblock %}

{% extends 'base.html' %}
{% block content %}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<h2 class="mb-3">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è: {{ event.title }}</h2>

<div class="mb-3">
    <strong>–î–∞—Ç–∞:</strong> {{ event.date|date:"j E Y –≤ H:i" }}
</div>

<div class="mb-4 d-flex gap-2">
    <a href="{% url 'event_stats_pdf' event.id %}" class="btn btn-outline-secondary">üì• –°–∫–∞—á–∞—Ç—å PDF</a>
    <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-dark">‚Üê –ù–∞–∑–∞–¥</a>
</div>

<hr>

<h4>üë• –ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h4>
<ul>
    <li>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ total }}</li>
    <li>‚úÖ –ü—Ä–∏—à–ª–∏: {{ attended }}</li>
    <li>‚ùå –ù–µ –ø—Ä–∏—à–ª–∏: {{ missed }}</li>
</ul>

<canvas id="attendanceChart" width="400" height="200" class="mb-5"></canvas>

<hr>

<h4>‚≠ê –°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:</h4>
<p class="fs-4">{{ avg_rating|default:"‚Äî" }}/5</p>

<hr>

<h4>üìà –†–µ–π—Ç–∏–Ω–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h4>

<canvas id="ratingsChart" width="600" height="300" class="mb-4"></canvas>

<table class="table table-bordered table-striped">
    <thead class="table-dark">
        <tr>
            <th>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
            <th>–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</th>
            <th>–û—Ç–∑—ã–≤—ã</th>
        </tr>
    </thead>
    <tbody>
        {% for a in activity_data %}
        <tr>
            <td>{{ a.title }}</td>
            <td>{{ a.avg_rating|floatformat:1 }}</td>
            <td>{{ a.feedback_count }}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="3" class="text-muted text-center">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- JS-–¥–∏–∞–≥—Ä–∞–º–º—ã -->
<script>
    const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
    const ratingsCtx = document.getElementById('ratingsChart').getContext('2d');

    const attendanceChart = new Chart(attendanceCtx, {
        type: 'pie',
        data: {
            labels: ['–ü—Ä–∏—à–ª–∏', '–ù–µ –ø—Ä–∏—à–ª–∏'],
            datasets: [{
                data: [{{ attended }}, {{ missed }}],
                backgroundColor: ['#4CAF50', '#F44336'],
            }]
        },
        options: {
            plugins: {
                title: {
                    display: true,
                    text: '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å'
                }
            }
        }
    });

    const ratingsChart = new Chart(ratingsCtx, {
        type: 'bar',
        data: {
            labels: [{% for a in activity_data %}'{{ a.title|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥',
                data: [{% for a in activity_data %}{{ a.avg_rating|default:"0" }}{% if not forloop.last %}, {% endif %}{% endfor %}],
                backgroundColor: '#2196F3'
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true,
                    max: 5
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: '–†–µ–π—Ç–∏–Ω–≥–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π'
                }
            }
        }
    });
</script>

{% endblock %}
